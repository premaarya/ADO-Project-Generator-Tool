# Reusable template for Docker builds
parameters:
- name: dockerfilePath
  type: string
  default: 'Dockerfile'
- name: imageName
  type: string
- name: containerRegistry
  type: string
  default: ''
- name: runSecurityScan
  type: boolean
  default: true
- name: buildContext
  type: string
  default: '.'
- name: additionalTags
  type: object
  default: []

steps:
- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    command: 'build'
    repository: '${{ parameters.imageName }}'
    dockerfile: '${{ parameters.dockerfilePath }}'
    buildContext: '${{ parameters.buildContext }}'
    tags: |
      $(Build.BuildId)
      latest
      ${{ join('\n', parameters.additionalTags) }}

- ${{ if eq(parameters.runSecurityScan, true) }}:
  - script: |
      docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity HIGH,CRITICAL ${{ parameters.imageName }}:$(Build.BuildId) || true
    displayName: 'Run Security Scan (Trivy)'
    continueOnError: true

- ${{ if ne(parameters.containerRegistry, '') }}:
  - task: Docker@2
    displayName: 'Push Docker Image'
    inputs:
      command: 'push'
      containerRegistry: '${{ parameters.containerRegistry }}'
      repository: '${{ parameters.imageName }}'
      tags: |
        $(Build.BuildId)
        latest
        ${{ join('\n', parameters.additionalTags) }}

- task: PublishBuildArtifacts@1
  displayName: 'Publish Dockerfile'
  inputs:
    PathtoPublish: '${{ parameters.dockerfilePath }}'
    ArtifactName: 'docker-configs'
    publishLocation: 'Container'
